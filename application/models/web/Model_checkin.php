<?php if (!defined('BASEPATH')) exit('No direct script access allowed');class Model_checkin extends CI_Model{    function __construct()    {        parent::__construct();    }        function getLocations($lat, $long){         $sql   = "SELECT z.showroom_id,                    z.showroom_name,                    z.showroom_address,                    z.latitude, z.longitude,                    p.distance_unit                             * DEGREES(ACOS(LEAST(1.0, COS(RADIANS(p.latpoint))                             * COS(RADIANS(z.latitude))                             * COS(RADIANS(p.longpoint) - RADIANS(z.longitude))                             + SIN(RADIANS(p.latpoint))                             * SIN(RADIANS(z.latitude))))) AS distance_in_km              FROM tbl_showroom AS z              JOIN (   /* these are the query parameters */                    SELECT  $lat  AS latpoint,  $long AS longpoint,                           0.009 AS radius,      111.045 AS distance_unit                ) AS p ON 1=1              WHERE z.latitude                 BETWEEN p.latpoint  - (p.radius / p.distance_unit)                     AND p.latpoint  + (p.radius / p.distance_unit)                AND z.longitude                 BETWEEN p.longpoint - (p.radius / (p.distance_unit * COS(RADIANS(p.latpoint))))                     AND p.longpoint + (p.radius / (p.distance_unit * COS(RADIANS(p.latpoint))))                AND showroom_active_status=1                ORDER BY distance_in_km              LIMIT 1";        $query	= $this->db->query($sql);		$rs		= $query->result_array(); 				return $rs;    }                    function getProfile($quest_id, $email)    {        if ($email != '') {            $where = "WHERE quest_id = '" . $quest_id . "' and  email = '" . $email . "' ";        }        $query = " Select a.quest_id ,a.register_id ,a.first_name,a.last_name ,a.email ,a.phone ,a.password ," . " DATE_FORMAT( a.date_of_birth, '%d-%m-%Y %H:%i:%s' ) as date_of_birth," . "a.address1,a.address2 ,a.province_id ,a.city_id ,a.districts_id ,a.villages_id ,a.postal_code_id ," . " a.phone ,a.photo ,a.ktp ,a.npwp ,a.no_ktp ,a.no_npwp ,a.account_number ,a.account_bank_name ," . " a.bank_code ,a.status , a.step ," . " DATE_FORMAT( a.signup_date, '%d-%m-%Y %H:%i:%s' ) as signup_date, a.fb_link ,a.tw_link, a.gplus_link,a.wa,a.bbm, a.about, " . " b.province_name, b.province_id , c.city_name, " . " d.districts_id, d.districts_name, e.villages_id, e.villages_name, f.postal_code_id, f.postal_code_name, " . " g.bank_code, g.bank_name " . " FROM tbl_quest as a " . " inner join tbl_province as b on a.province_id = b.province_id " . " inner join tbl_city as c on a.city_id  = c.city_id " . " inner join tbl_districts as d on a.districts_id  = d.districts_id " . " inner join tbl_villages as e on a.villages_id  = e.villages_id " . " inner join tbl_postal_code as f on a.postal_code_id  = f.postal_code_id " . " inner join tbl_bank as g on a.bank_code  = g.bank_code " . " $where ";        $query = $this->db->query($query)->result_array();        return $query;    }     function checkShowroom($showroom_id,$quest_validation)    {            $data  = array();        $sql   = "select * from tbl_showroom WHERE showroom_id= $showroom_id and  showroom_validation COLLATE latin1_general_cs ='" . strtoupper($quest_validation). "'";               $query = $this->db->query($sql)->result_array();        return $query;                    }    function checkQuest($quest_idcard, $quest_phone, $quest_email)    {        if ($quest_email != '') {            $where = "WHERE a.quest_idcard = '" . $quest_idcard . "' or a.quest_phone = '" . $quest_phone . "' or  a.quest_email = '" . $quest_email . "' ";            $query = " Select a.quest_id,a.quest_name,a.quest_phone,a.quest_email, a.quest_idcard"                            . " FROM tbl_quest as a "                            . " $where ";        $query = $this->db->query($query)->result_array();        return $query;                    } else {             return '';        }            }    function addQuest($quest_type, $quest_name, $quest_idcard, $quest_phone, $quest_email)    {        $sql     = "INSERT INTO tbl_quest SET                             quest_type=$quest_type,                            quest_name='" . $quest_name . "',                            quest_idcard='" . $quest_idcard . "',                            quest_phone='" . $quest_phone . "',                            quest_email='" . $quest_email . "' ";        $query   = $this->db->query($sql);        $last_id = $this->db->insert_id();        return $last_id;    }           function updateQuest($id,$quest_type, $quest_name, $quest_idcard, $quest_phone, $quest_email)    {        $sql     = "UPDATE  tbl_quest SET                             quest_type=$quest_type,                            quest_name='" . $quest_name . "',                            quest_idcard='" . $quest_idcard . "',                            quest_phone='" . $quest_phone . "',                            quest_email='" . $quest_email . "'                             WHERE quest_id ='" . $id . "' ";        $query   = $this->db->query($sql);        $last_id = $this->db->insert_id();        return $last_id;    }        function checkCheckin($id, $showroom_id){        if ($id != '' && $showroom_id !='') {            $where = "WHERE a.quest_id = $id and a.showroom_id = $showroom_id and  a.checkout_date IS NULL ";            $query = " Select a.checkin_id, a.quest_id,a.showroom_id,a.checkin_date"                            . " FROM tbl_checkin as a "                            . " $where ";        $query = $this->db->query($query)->result_array();        return $query;                    } else {             return '';        }    }        function addCheckin($quest_id ,$showroom_id, $quest_temp,$checkin_date)    {         $sql     = "INSERT INTO tbl_checkin SET                             quest_id=$quest_id,                            showroom_id=$showroom_id,                            quest_temp='" . $quest_temp . "',                            checkin_date='" . $checkin_date . "' ";        $query   = $this->db->query($sql);        $last_id = $this->db->insert_id();        return $last_id;    }      function updateCheckin($quest_id,$checkin_id, $checkout_date)    {          $sql     = "UPDATE  tbl_checkin SET                             checkout_date='" . $checkout_date . "'                             WHERE checkin_id =$checkin_id and quest_id ='" . $quest_id . "' ";        $query = $this->db->query($sql);        return $query;    }        function cronCheckin($checkout_date){        $where = "WHERE and a.checkout_date IS NULL ";         // $query = " Select a.checkin_id, a.quest_id,a.showroom_id,a.checkin_date, TIMEDIFF('$checkout_date',a.checkin_date) as tm FROM tbl_checkin as a       // where TIMEDIFF('$checkout_date',a.checkin_date) >= '08:00:00' and `checkout_date` is NULL";        $query = " Select a.checkin_id, a.quest_id,a.showroom_id,a.checkin_date, TIMEDIFF('$checkout_date',a.checkin_date) as tm FROM tbl_checkin as a        where `checkout_date` is NULL";        $query = $this->db->query($query)->result_array();        return $query;             }                                        function verifyEmailAddress($verificationCode)    {        $sql   = "UPDATE tbl_quest SET  step = 1  WHERE email_verification_code = '" . $verificationCode . "' and status=0";        $query = $this->db->query($sql);        return $query;    }      function cekSignUp($email, $password)    {        $data  = array();        $sql   = "select * from tbl_quest where email ='" .$email. "' and password= '" .$password."' and status = 1";        $hasil = $this->db->query($sql);        if ($hasil->num_rows() > 0) {            $data = $hasil->result();        }        $hasil->free_result();        $this->db->close();        return $data;    }    function getPersonal($quest_id)    {        $data  = array();        $sql   = "select a.*, b.province_name from tbl_quest a " . " inner join tbl_province as b on a.province_id = b.province_id " . " where a.quest_id='$quest_id' and a.status = 1 ";        $hasil = $this->db->query($sql);        if ($hasil->num_rows() > 0) {            $data = $hasil->result();        }        $hasil->free_result();        $this->db->close();        return $data;    }    function updatePassword($quest_id, $newpass)    {        $sql   = "UPDATE tbl_quest SET                    password='" . $newpass . "' WHERE quest_id = " . $quest_id . "";        $query = $this->db->query($sql);        return $query;    }      function cekPassword($quest_id, $password)    {        $data  = array();        $sql   = "select quest_id as a from tbl_quest where quest_id='$quest_id' and password= '" . $password . "' and status = 1 ";        $hasil = $this->db->query($sql);        if ($hasil->num_rows() > 0) {            $data = $hasil->result();        }        $hasil->free_result();        $this->db->close();        return $data;    }    function checkEmailEdit($email, $quest_id)    {        $query = $this->db->query("select * from tbl_quest WHERE email ='" . $email . "' and quest_id =" . $quest_id . " ");        return $query;    }    function checkEmailNoEdit($email, $quest_id)    {        $query = $this->db->query("select * from tbl_quest WHERE email ='" . $email . "' and quest_id <>" . $quest_id . " ");        return $query;    }    function newverifyEmailAddress($verificationCode)          {                  $sql	= "UPDATE tbl_quest SET  step= 1 WHERE email_verification_code = '".$verificationCode."' and status=0";			$query	= $this->db->query($sql);		return $query;        }                 function getByVerify($verificationText)		        {	                                         $sql = "select * from tbl_quest where email_verification_code='$verificationText'";		                                                                 $hasil = $this->db->query($sql);                        if($hasil->num_rows() > 0){				$data = $hasil->result();			}			$hasil->free_result();                        $this->db->close();			return $data;       //     return $query;                        		        }          function insertSubscribe($subscribe_email)	{		$sql	= "INSERT INTO tbl_subscriber SET "                        . " email='".$subscribe_email."',"                        . " subscriber_date = now(), "                        . "subscriber_status= 1";                $query  = $this->db->query($sql);		$last_id  = $this->db->insert_id();		return $last_id;	}             function   AddContactUs ($from, $name,$email, $subject, $message){        {		$sql	= "INSERT INTO tbl_contactus SET "                        . " contactus_from='".$from."',"                        . " contactus_name='".$name."',"                        . " contactus_email='".$email."',"                        . " contactus_subject='".$subject."',"                        . " contactus_message='".$message."',"                        . " contactus_date = now() ";                $query  = $this->db->query($sql);		$last_id  = $this->db->insert_id();		return $last_id;	}      }}